pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                // Clone your Git repo
                git branch: 'main', url: 'https://github.com/bhagyajkumar/jenkins-learn.git'
            }
        }

        stage('Check Python') {
            steps {
                // Verify Python3 and pip3 are available
                sh '''
                echo "Checking Python installation..."
                which python3 || { echo "python3 not found"; exit 1; }
                python3 --version
                pip3 --version
                '''
            }
        }

        stage('Setup Virtual Environment') {
            steps {
                // Create venv and activate
                sh '''
                echo "Creating virtual environment..."
                python3 -m venv venv
                . venv/bin/activate
                pip install --upgrade pip
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                // Install dependencies if requirements.txt exists
                sh '''
                . venv/bin/activate
                if [ -f requirements.txt ]; then
                    echo "Installing dependencies from requirements.txt..."
                    pip install -r requirements.txt
                else
                    echo "No requirements.txt found, skipping."
                fi
                '''
            }
        }

        stage('Run Python Script') {
            steps {
                // Run your Python script inside venv
                sh '''
                . venv/bin/activate
                if [ -f main.py ]; then
                    echo "Running main.py..."
                    python main.py
                else
                    echo "No main.py found, running demo Hello World"
                    echo "print('Hello, World!')" > hello.py
                    python hello.py
                fi
                '''
            }
        }
    }

    post {
        always {
            echo "Pipeline finished!"
        }
    }
}
